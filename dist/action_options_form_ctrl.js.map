{"version":3,"sources":["../src/action_options_form_ctrl.js"],"names":["showActionOptionsForm","productionLine","orderId","productDesc","productId","tags","prodLine","prodDesc","prodId","_allData","tableCtrl","allData","getRowData","then","init","res","catch","utils","alert","e","_rowData","status","toLowerCase","cons","STATE_PLAN","STATE_READY","appEvents","emit","src","modalClass","model","removeListeners","addListeners","Promise","resolve","reject","data","filter","order","production_line","order_id","product_id","length","url","postgRestHost","get","_orderStates","$","document","on","target","id","showOrderEditingForm","closeForm","updateOrder","STATE_DELETED","off","action","line","writeInfluxLine","deleteCurrentAndUpdateAffectOrders","post","influx","writeUrl","refreshDashboard","promises","affectedOrders","scheduled_start_datetime","scheduled_end_datetime","order_date","deletingOrderDurationHour","moment","duration","order_qty","planned_rate","deletingOrderChangeover","planned_changeover_time","deletingOrderTotalDur","add","forEach","writeLineForTimeUpdate","push","all","compl_qty","undefined","machine_state","scrap_qty","setpoint_rate","product_desc","trigger"],"mappings":";;;;;;;AAgBA;;;;;;;;;AASA,WAASA,qBAAT,CAA+BC,cAA/B,EAA+CC,OAA/C,EAAwDC,WAAxD,EAAqEC,SAArE,EAA+E;AAC7E;AACA,QAAIC,OAAO,EAACC,UAAUL,cAAX,EAA2BC,SAASA,OAApC,EAA6CK,UAAUJ,WAAvD,EAAoEK,QAAQJ,SAA5E,EAAX;AACAK,eAAWC,UAAUC,OAAV,EAAX;AACAC,eAAWH,QAAX,EAAqBJ,IAArB,EAA2BQ,IAA3B,CAAgC,eAAO;AAACC,WAAKC,GAAL;AAAU,KAAlD,EAAoDC,KAApD,CAA0D,aAAK;AAACC,YAAMC,KAAN,CAAY,OAAZ,EAAqB,OAArB,EAA8BC,CAA9B;AAAiC,KAAjG;AACD;;AAED,WAASL,IAAT,CAAcC,GAAd,EAAkB;AAChBK,eAAWL,GAAX;AACA,QAAGK,SAASC,MAAT,CAAgBC,WAAhB,OAAkCC,KAAKC,UAAvC,IAAqDJ,SAASC,MAAT,CAAgBC,WAAhB,OAAkCC,KAAKE,WAA/F,EAA2G;AACzGR,YAAMC,KAAN,CAAY,SAAZ,EAAuB,SAAvB,EAAkC,mBAAmBE,SAASC,MAA5B,GAAqC,yCAAvE;AACA;AACD;;AAEDK,cAAUC,IAAV,CAAe,YAAf,EAA6B;AAC3BC,WAAK,2FADsB;AAE3BC,kBAAY,eAFe;AAG3BC,aAAO;AAHoB,KAA7B;;AAMAC;AACAC;AACD;;AAED;;;;;;AAMA,WAASpB,UAAT,CAAoBD,OAApB,EAA6BN,IAA7B,EAAkC;AAChC,WAAO,IAAI4B,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACtC,UAAMC,OAAQzB,QAAQ0B,MAAR,CAAe;AAAA,eAASC,MAAMC,eAAN,KAA0BlC,KAAKC,QAA/B,IACjCgC,MAAME,QAAN,KAAmBnC,KAAKH,OADS,IAEjCoC,MAAMG,UAAN,KAAqBpC,KAAKG,MAFF;AAAA,OAAf,EAEyB,CAFzB,CAAd;AAGE,UAAI4B,KAAKM,MAAL,KAAgB,CAApB,EAAuB;AACrBP,eAAO,iBAAP;AACD,OAFD,MAEM;AACJ,YAAMQ,MAAS1B,MAAM2B,aAAf,gBAAN;AACA3B,cAAM4B,GAAN,CAAUF,GAAV,EAAe9B,IAAf,CAAoB,eAAO;AACzBiC,yBAAe/B,GAAf;AACAmB,kBAAQE,IAAR;AACD,SAHD,EAGGpB,KAHH,CAGS,aAAK;AACZmB;AACD,SALD;AAMD;AACJ,KAfM,CAAP;AAgBD;;AAED;;;;;;AAMA,WAASH,YAAT,GAAwB;AACtBe,MAAEC,QAAF,EAAYC,EAAZ,CAAe,OAAf,EAAwB,+DAAxB,EAAyF,aAAK;;AAE5F,UAAI9B,EAAE+B,MAAF,CAASC,EAAT,KAAgB,MAApB,EAA4B;AAC1BC,6BAAqBhC,QAArB,EAA+BX,QAA/B;AACD,OAFD,MAEM,IAAIU,EAAE+B,MAAF,CAASC,EAAT,KAAgB,SAApB,EAA+B;AACnC,YAAI/B,SAASC,MAAT,CAAgBC,WAAhB,OAAkCC,KAAKE,WAA3C,EAAwD;AACtDR,gBAAMC,KAAN,CAAY,SAAZ,EAAuB,SAAvB,EAAkC,iCAAlC;AACAmC;AACD,SAHD,MAGM;AACJC,sBAAY/B,KAAKE,WAAjB;AACD;AACF,OAPK,MAOA,IAAIN,EAAE+B,MAAF,CAASC,EAAT,KAAgB,QAApB,EAA8B;AAClCG,oBAAY/B,KAAKgC,aAAjB;AACD;AAEF,KAfD;AAgBD;;AAED;;;AAGA,WAASxB,eAAT,GAA2B;AACzBgB,MAAEC,QAAF,EAAYQ,GAAZ,CAAgB,OAAhB,EAAyB,+DAAzB;AACD;;AAED;;;;;;;AAOA,WAASF,WAAT,CAAqBG,MAArB,EAA6B;AAC3B,QAAMC,OAAOC,gBAAgBF,MAAhB,CAAb;AACA,QAAIA,OAAOnC,WAAP,OAAyBC,KAAKgC,aAAlC,EAAiD;AAC/CK,yCAAmCF,IAAnC;AACD,KAFD,MAEK;AACHzC,YAAM4C,IAAN,CAAWC,OAAOC,QAAlB,EAA4BL,IAA5B,EAAkC7C,IAAlC,CAAuC,eAAO;AAC5CI,cAAMC,KAAN,CAAY,SAAZ,EAAuB,SAAvB,EAAkC,8BAA8BuC,MAAhE;AACAJ;AACA3C,kBAAUsD,gBAAV;AACD,OAJD,EAIGhD,KAJH,CAIS,aAAK;AACZC,cAAMC,KAAN,CAAY,OAAZ,EAAqB,gBAArB,EAAuC,4DAA4DC,CAA5D,GAAgE,sCAAvG;AACAkC;AACD,OAPD;AAQD;AACF;;AAED,WAASO,kCAAT,CAA4CF,IAA5C,EAAiD;AAC/C;AACA,QAAIO,WAAW,CAAChD,MAAM4C,IAAN,CAAWC,OAAOC,QAAlB,EAA4BL,IAA5B,CAAD,CAAf;;AAEA;AACA,QAAM/C,UAAUD,UAAUC,OAAV,EAAhB;;AAEA;AACA;AACA,QAAMuD,iBAAiBvD,QAAQ0B,MAAR,CAAe;AAAA,aAASC,MAAM6B,wBAAN,IAAkC/C,SAASgD,sBAA3C,IAAqE9B,MAAMC,eAAN,KAA0BnB,SAASmB,eAAxG,IAA2HD,MAAM+B,UAAN,KAAqBjD,SAASiD,UAAlK;AAAA,KAAf,CAAvB;;AAEA;AACA,QAAMC,4BAA4BC,OAAOC,QAAP,CAAgBpD,SAASqD,SAAT,GAAqBrD,SAASsD,YAA9C,EAA4D,OAA5D,CAAlC;AACA,QAAMC,0BAA0BJ,OAAOC,QAAP,CAAgBpD,SAASwD,uBAAzB,EAAkD,SAAlD,CAAhC;AACA,QAAMC,wBAAwBP,0BAA0BQ,GAA1B,CAA8BH,uBAA9B,CAA9B;;AAEA;AACAT,mBAAea,OAAf,CAAuB,iBAAS;AAC9B,UAAMrB,OAAOI,OAAOkB,sBAAP,CAA8B1C,KAA9B,EAAqCuC,qBAArC,EAA4D,UAA5D,CAAb;AACAZ,eAASgB,IAAT,CAAchE,MAAM4C,IAAN,CAAWC,OAAOC,QAAlB,EAA4BL,IAA5B,CAAd;AACD,KAHD;;AAKAzB,YAAQiD,GAAR,CAAYjB,QAAZ,EAAsBpD,IAAtB,CAA2B,YAAM;AAC/BI,YAAMC,KAAN,CAAY,SAAZ,EAAuB,SAAvB,EAAkC,kCAAlC;AACAmC;AACA3C,gBAAUsD,gBAAV;AACD,KAJD,EAIGhD,KAJH,CAIS,aAAK;AACZC,YAAMC,KAAN,CAAY,OAAZ,EAAqB,gBAArB,EAAuC,kDAAkDC,CAAzF;AACAkC;AACD,KAPD;AAQD;;AAED;;;;;AAKA,WAASM,eAAT,CAAyBtC,MAAzB,EAAgC;AAC9B;AACA;;AAEA,QAAIqC,sCAAoCtC,SAASoB,QAA7C,oBAAoEpB,SAASqB,UAA7E,MAAJ;;AAEA,QAAIrB,SAAS+D,SAAT,KAAuB,IAAvB,IAA+B/D,SAAS+D,SAAT,KAAuBC,SAA1D,EAAqE;AACnE1B,cAAQ,eAAetC,SAAS+D,SAAxB,GAAoC,GAA5C;AACD;AACD,QAAI/D,SAASiE,aAAT,KAA2B,IAA3B,IAAmCjE,SAASiE,aAAT,KAA2BD,SAAlE,EAA6E;AAC3E1B,cAAQ,oBAAoBtC,SAASiE,aAA7B,GAA6C,GAA7C,GAAmD,GAA3D;AACD;AACD,QAAIjE,SAASkE,SAAT,KAAuB,IAAvB,IAA+BlE,SAASkE,SAAT,KAAuBF,SAA1D,EAAqE;AACnE1B,cAAQ,eAAetC,SAASkE,SAAxB,GAAoC,GAA5C;AACD;AACD,QAAIlE,SAASmE,aAAT,KAA2B,IAA3B,IAAmCnE,SAASmE,aAAT,KAA2BH,SAAlE,EAA6E;AAC3E1B,cAAQ,mBAAmBtC,SAASmE,aAA5B,GAA4C,GAApD;AACD;;AAED,QAAInE,SAASgD,sBAAT,KAAoC,IAApC,IAA4ChD,SAASgD,sBAAT,KAAoCgB,SAApF,EAA+F;AAC7F1B,cAAQ,4BAA4BtC,SAASgD,sBAArC,GAA8D,GAAtE;AACAV,cAAQ,8BAA8BtC,SAAS+C,wBAAvC,GAAkE,GAA1E;AACD;;AAEDT,YAAQ,kBAAkBrC,MAAlB,GAA2B,GAA3B,GAAiC,GAAzC;AACAqC,YAAQ,mBAAmBtC,SAASoE,YAA5B,GAA2C,GAA3C,GAAiD,GAAzD;AACA9B,YAAQ,iBAAiBtC,SAASiD,UAA1B,GAAuC,GAAvC,GAA6C,GAArD;AACAX,YAAQ,8BAA8BtC,SAASwD,uBAAvC,GAAiE,GAAjE,GAAuE,GAA/E;AACAlB,YAAQ,sBAAsBtC,SAASmB,eAA/B,GAAiD,GAAjD,GAAuD,GAA/D;AACAmB,YAAQ,eAAetC,SAASqD,SAAxB,GAAoC,GAA5C;AACAf,YAAQ,kBAAkBtC,SAASsD,YAAnC;;AAEF;AACA;AACE,WAAOhB,IAAP;AACD;;;;AAzMQN,0B,oBAAAA,oB;;AACA1B,e,gBAAAA,S;;AACGT,W;;AACAP,e;;AACAoD,Y;;AACAvC,U;;AACLgD,Y;;;AAEHnD,c;AACAX,c;AACAqC,kB;;AAEEO,e,GAAY,SAAZA,SAAY,GAAM;AACtBN,UAAE,+CAAF,EAAmD0C,OAAnD,CAA2D,OAA3D;AACD,O;;uCA6LQzF,qB","file":"action_options_form_ctrl.js","sourcesContent":["import { showOrderEditingForm } from './order_form_ctrl'\nimport { appEvents } from 'app/core/core'\nimport * as utils from './utils'\nimport * as tableCtrl from './table_ctrl'\nimport * as influx from './influxHelper'\nimport * as cons from './constants'\nimport moment from 'moment'\n\nlet _rowData\nlet _allData\nlet _orderStates\n\nconst closeForm = () => {\n  $('a#order-mgt-scheduler-action-option-close-btn').trigger('click')\n}\n\n/**\n * Expect four params which are the tags values and are for querying the record data\n * Show the action options form once the query is finished\n * Remove listener and then add listener, which is to prevent listeners duplication\n * @param {*} productionLine \n * @param {*} orderId \n * @param {*} productDesc \n * @param {*} productId \n */\nfunction showActionOptionsForm(productionLine, orderId, productDesc, productId){\n  //get data\n  let tags = {prodLine: productionLine, orderId: orderId, prodDesc: productDesc, prodId: productId}\n  _allData = tableCtrl.allData()\n  getRowData(_allData, tags).then(res => {init(res)}).catch(e => {utils.alert('error', 'Error', e)})\n}\n\nfunction init(res){\n  _rowData = res\n  if(_rowData.status.toLowerCase() !== cons.STATE_PLAN && _rowData.status.toLowerCase() !== cons.STATE_READY){\n    utils.alert('warning', 'Warning', 'This order is ' + _rowData.status + ' and is no longer available for editing')\n    return\n  }\n\n  appEvents.emit('show-modal', {\n    src: 'public/plugins/smart-factory-scheduler-order-mgt-table-panel/partials/action_options.html',\n    modalClass: 'confirm-modal',\n    model: {}\n  })\n\n  removeListeners()\n  addListeners()\n}\n\n/**\n * Use the tags to filter out the clicked order data from all data\n * And return it\n * @param {*} allData All orders\n * @param {*} tags The tags of the order that is clicked\n */\nfunction getRowData(allData, tags){\n  return new Promise((resolve, reject) => {\n    const data =  allData.filter(order => order.production_line === tags.prodLine \n      && order.order_id === tags.orderId \n      && order.product_id === tags.prodId)[0]\n      if (data.length === 0) {\n        reject('Order not found')\n      }else {\n        const url = `${utils.postgRestHost}order_state`\n        utils.get(url).then(res => {\n          _orderStates = res\n          resolve(data)\n        }).catch(e => {\n          reject(`error due to order state configuration`)\n        })\n      }\n  })\n}\n\n/**\n * Add listener for the action selection\n * If edit clicked, go to the edit form with the current record data\n * If realease clicked, change record status to 'Ready'\n * If delete clicked, change record status to 'Deleted'\n */\nfunction addListeners() {\n  $(document).on('click', 'input[type=\"radio\"][name=\"order-mgt-scheduler-actions-radio\"]', e => {\n    \n    if (e.target.id === 'edit') {\n      showOrderEditingForm(_rowData, _allData)\n    }else if (e.target.id === 'release') {\n      if (_rowData.status.toLowerCase() === cons.STATE_READY) {\n        utils.alert('warning', 'Warning', 'Order has already been released')\n        closeForm()\n      }else {\n        updateOrder(cons.STATE_READY)\n      }\n    }else if (e.target.id === 'delete') {\n      updateOrder(cons.STATE_DELETED)\n    }\n\n  })\n}\n\n/**\n * Remove listener for the action selection\n */\nfunction removeListeners() {\n  $(document).off('click', 'input[type=\"radio\"][name=\"order-mgt-scheduler-actions-radio\"]')\n}\n\n/**\n * Expect the action string (Normally are: 'Ready' or 'Deleted')\n * Use the action var passed in to write the line\n * Then update the record\n * Stop and prompt error if it fails\n * @param {*} action \n */\nfunction updateOrder(action) {\n  const line = writeInfluxLine(action)\n  if (action.toLowerCase() === cons.STATE_DELETED) {\n    deleteCurrentAndUpdateAffectOrders(line)\n  }else{\n    utils.post(influx.writeUrl, line).then(res => {\n      utils.alert('success', 'Success', 'Order has been marked as ' + action)\n      closeForm()\n      tableCtrl.refreshDashboard()\n    }).catch(e => {\n      utils.alert('error', 'Database Error', 'An error occurred while writing data to the influxdb : ' + e + 'please check the basebase connection')\n      closeForm()\n    })\n  }\n}\n\nfunction deleteCurrentAndUpdateAffectOrders(line){\n  //create promises array and put the 'delete current order request' into it first\n  let promises = [utils.post(influx.writeUrl, line)]\n\n  //get all orders data for further filtering\n  const allData = tableCtrl.allData()\n\n  //filter affected orders using all orders data\n  //affected orders = order.startTime >= thisOrder.endtime && in the same line && with the same date.\n  const affectedOrders = allData.filter(order => order.scheduled_start_datetime >= _rowData.scheduled_end_datetime && order.production_line === _rowData.production_line && order.order_date === _rowData.order_date)\n  \n  //work out thisOrder's total duration, which = its duration + its changeover duration\n  const deletingOrderDurationHour = moment.duration(_rowData.order_qty / _rowData.planned_rate, 'hours') \n  const deletingOrderChangeover = moment.duration(_rowData.planned_changeover_time, 'H:mm:ss')\n  const deletingOrderTotalDur = deletingOrderDurationHour.add(deletingOrderChangeover)\n  \n  //loop affected orders, order's starttime and endtime should both subtract the total duration worked out\n  affectedOrders.forEach(order => {\n    const line = influx.writeLineForTimeUpdate(order, deletingOrderTotalDur, 'subtract')\n    promises.push(utils.post(influx.writeUrl, line))\n  })\n\n  Promise.all(promises).then(() => {\n    utils.alert('success', 'Success', 'Order has been marked as Deleted')\n    closeForm()\n    tableCtrl.refreshDashboard()\n  }).catch(e => {\n    utils.alert('error', 'Database Error', 'An error occurred while deleting the order : ' + e)\n    closeForm()\n  })\n}\n\n/**\n * Expect the status string (Normally are: 'Ready' or 'Deleted')\n * Then changed the status in the line with anything else unchanged\n * @param {*} status \n */\nfunction writeInfluxLine(status){\n  //For influxdb tag keys, must add a forward slash \\ before each space \n  // let product_desc = _rowData.product_desc.split(' ').join('\\\\ ')\n\n  let line = `OrderPerformance,order_id=${_rowData.order_id},product_id=${_rowData.product_id} `\n\n  if (_rowData.compl_qty !== null && _rowData.compl_qty !== undefined) {\n    line += 'compl_qty=' + _rowData.compl_qty + ','\n  }\n  if (_rowData.machine_state !== null && _rowData.machine_state !== undefined) {\n    line += 'machine_state=\"' + _rowData.machine_state + '\"' + ','\n  }\n  if (_rowData.scrap_qty !== null && _rowData.scrap_qty !== undefined) {\n    line += 'scrap_qty=' + _rowData.scrap_qty + ','\n  }\n  if (_rowData.setpoint_rate !== null && _rowData.setpoint_rate !== undefined) {\n    line += 'setpoint_rate=' + _rowData.setpoint_rate + ','\n  }\n\n  if (_rowData.scheduled_end_datetime !== null && _rowData.scheduled_end_datetime !== undefined) {\n    line += 'scheduled_end_datetime=' + _rowData.scheduled_end_datetime + ','\n    line += 'scheduled_start_datetime=' + _rowData.scheduled_start_datetime + ','\n  }\n\n  line += 'order_state=\"' + status + '\"' + ','\n  line += 'product_desc=\"' + _rowData.product_desc + '\"' + ','\n  line += 'order_date=\"' + _rowData.order_date + '\"' + ','\n  line += 'planned_changeover_time=\"' + _rowData.planned_changeover_time + '\"' + ','\n  line += 'production_line=\"' + _rowData.production_line + '\"' + ','\n  line += 'order_qty=' + _rowData.order_qty + ','\n  line += 'planned_rate=' + _rowData.planned_rate\n\n//   console.log('writeInfluxLine');\n//   console.log(line);\n  return line\n}\n\nexport { showActionOptionsForm }"]}