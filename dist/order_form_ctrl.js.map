{"version":3,"sources":["../src/order_form_ctrl.js"],"names":["showOrderEditingForm","data","rowData","getProductsAndEquipments","callback","appEvents","emit","src","modalClass","model","tryCatchCount","tryCatchCtrl","removeListeners","addListeners","setTimeout","startCtrl","e","console","log","$","trigger","utils","alert","enableInstantSearch","products","equipment","datepicker","orientation","todayBtn","format","autoclose","timepicker","showMeridian","showSeconds","maxHours","minuteStep","secondStep","defaultTime","icons","up","down","prefillData","productsUrl","postgRestHost","equipmentsUrl","get","then","res","catch","val","order_id","order_qty","production_line","product_id","product_desc","order_date","planned_rate","planned_changeover_time","updateDuration","document","on","serializeArray","submitOrder","value","off","qty","rate","durationHrs","parseInt","momentDuration","moment","duration","durationText","getDurationText","month","days","hrs","mins","text","inputValues","orderId","orderQty","productionLine","product","date","plannedRate","changeover","isValueValid","url","influxHost","hasTagsChanged","updateWithTagsChanged","updateWithTagsUnchanged","input","newLine","writeInfluxLine","oldLine","writeOldInfluxLine","post","error","line","undefined","inputs","split","dateRegExp","RegExp","prodList","reduce","arr","p","str","push","productionLineList","equ","site","area","distinctElems","indexOf","test","join","completion_qty","machine_state","scrap_qty","setpoint_rate","bootstrap_datepicker","bootstrap_timepicker","_orderDurationHours"],"mappings":"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","file":"order_form_ctrl.js","sourcesContent":["import * as utils from './utils'\nimport moment from 'moment'\nimport { appEvents } from 'app/core/core'\nimport { enableInstantSearch } from './instant_search_ctrl'\nimport  * as bootstrap_datepicker  from './libs/bootstrap-datepicker'\nimport  * as bootstrap_timepicker  from './libs/bootstrap-timepicker'\n\nlet products\nlet equipment\nlet rowData\nlet tryCatchCount = 1\nlet _orderDurationHours\n\n/**\n * This function is the entry point to show the order editing form\n * It accepts one param, with is called 'data'\n * This 'data' is empty when the user clicks the create icon to create a new order\n * This 'data' is not empty when the user clicks the row to edit the order, and the form will be pre-fill based on the data passed in\n * @param {*} data\n */\nfunction showOrderEditingForm (data) {\n\n  rowData = data\n  \n  getProductsAndEquipments(callback)\n\n  function callback () {\n\n    appEvents.emit('show-modal', {\n        src: 'public/plugins/smart-factory-scheduler-order-mgt-table-panel/partials/order_form.html',\n        modalClass: 'confirm-modal',\n        model: {}\n    })\n\n    tryCatchCount = 1\n    tryCatchCtrl()\n\n    removeListeners()\n    addListeners()\n  }\n}\n\n/**\n * Try enable the insatnt search function and the datepicker\n * Re-try if it fails\n * Stop and prompt error if it fails more than 15 times\n */\nfunction tryCatchCtrl(){\n  setTimeout(() => {\n    try {\n      startCtrl()\n    } catch (e) {\n      if (tryCatchCount < 15) {\n        tryCatchCtrl()\n        console.log('Re-init: ' + tryCatchCount);\n        tryCatchCount ++\n      }else {\n        console.log(e)\n        $('#order-mgt-scheduler-form-cancelBtn').trigger('click')\n        utils.alert('error', 'Error', 'Form initialisation failed, please try agian')\n      }\n    }\n  }, 200);\n}\n\n/**\n * Enable instant search function and the datepicker\n */\nfunction startCtrl(){\n  enableInstantSearch(products, equipment)\n  $('#datepicker').datepicker({\n      orientation: 'top',\n      todayBtn: 'linked',\n      format: 'yyyy-mm-dd',\n      autoclose: true,\n  })\n\n  $('#changeover-minutes-picker').timepicker({\n    showMeridian: false,\n    showSeconds: true,\n    maxHours: 100,\n    minuteStep: 1,\n    secondStep: 1,\n    defaultTime: '00:00:00',\n    icons: {\n        up: 'fa fa-chevron-up',\n        down: 'fa fa-chevron-down'\n    }\n  })\n\n  prefillData()\n}\n\n/**\n * Get the product list and production line list from postgresql\n * Call the callback fn passed in once it is finished\n * Stop and prompt error when it fails\n * @param {fn} callback \n */\nfunction getProductsAndEquipments (callback) {\n  let productsUrl = utils.postgRestHost + 'products'\n  let equipmentsUrl = utils.postgRestHost + 'equipment?production_line=not.is.null'\n\n  utils.get(productsUrl)\n    .then(res => {\n      products = res\n      utils.get(equipmentsUrl)\n        .then(res => {\n          equipment = res\n          callback()\n        })\n        .catch(e => {\n          console.log(e)\n          utils.alert('error', 'Error', 'An error occurred while fetching data from the postgresql, please check the basebase connection')\n        })\n    })\n    .catch(e => {\n      console.log(e)\n      utils.alert('error', 'Error', 'An error occurred while fetching data from the postgresql, please check the basebase connection')\n    })\n}\n\n/**\n * Pre-fiil the information when it comes with data (When the user clicks the row)\n */\nfunction prefillData(){\n  if (rowData) {\n    // console.log('need to pre-fill')\n    $('input.ord-mgt-datalist-input#order-id').val(rowData.order_id)\n    $('input.ord-mgt-datalist-input#order-qty').val(rowData.order_qty)\n    $('input.ord-mgt-datalist-input#datalist-input-production-line').val(rowData.production_line)\n    $('input.ord-mgt-datalist-input#datalist-input-products').val(rowData.product_id + ' | ' + rowData.product_desc)\n    $('input.ord-mgt-datalist-input#datepicker').val(rowData.order_date)\n    $('input.ord-mgt-datalist-input#planned-rate').val(rowData.planned_rate)\n    $('input.ord-mgt-datalist-input#changeover-minutes-picker').val(rowData.planned_changeover_time)\n    updateDuration(rowData.order_qty, rowData.planned_rate)\n  }\n}\n\n/**\n * Add click event listener for the submit btn\n */\nfunction addListeners(){\n  $(document).on('click', 'button#order-mgt-scheduler-form-submitBtn', e => {\n    let data = $('form#order-mgt-scheduler-form').serializeArray()\n    submitOrder(data)\n  })\n\n  $(document).on('input', 'input#planned-rate, input#order-qty', e => {\n    let data = $('form#order-mgt-scheduler-form').serializeArray()\n    updateDuration(data[1].value, data[5].value)\n  })\n}\n\n/**\n * Remove the click event listner for the submit btn\n */\nfunction removeListeners(){\n  $(document).off('click', 'button#order-mgt-scheduler-form-submitBtn')\n  $(document).off('input', 'input#planned-rate, input#order-qty')\n}\n\nfunction updateDuration(qty, rate){\n\n  if (qty !== \"\" && rate !== \"\") {\n    let durationHrs = parseInt(qty) / parseInt(rate)\n    let momentDuration = moment.duration(durationHrs, 'hours')\n\n    let durationText = getDurationText(momentDuration)\n    \n    $('input.ord-mgt-datalist-input#duration').val(durationText)\n  }else {\n    $('input.ord-mgt-datalist-input#duration').val('')\n  }\n}\n\nfunction getDurationText(momentDuration) {\n  let month = momentDuration.get('month')\n  let days = momentDuration.get('d')\n  let hrs = momentDuration.get('h')\n  let mins = momentDuration.get('minute')\n  let text = 'under 1 minute'\n\n  if (month > 0) {return 'Over a month!'}\n\n  if (days !== 0) { hrs += days * 24 }\n\n  if (hrs !== 0 && mins !== 0) {\n    text = hrs + ' hour(s) & ' + mins + ' minute(s)'\n  }else if (hrs !== 0 && mins === 0){\n    text = hrs + ' hour(s)'\n  }else if (hrs === 0 && mins !== 0){\n    text = mins + ' minute(s)'\n  }\n  \n  return text\n}\n\n/**\n * Expect the form data and then check if the form data is valid\n * If data is valid, check if the tags are changed, simply update the record if tags are unchanged\n * Or create a new record with the validated form data then update the old record's status as 'Replaced'\n * @param {*} data \n */\nfunction submitOrder(data) {\n  \n  const inputValues = {\n    orderId: data[0].value, \n    orderQty: data[1].value, \n    productionLine: data[2].value, \n    product: data[3].value, \n    date: data[4].value, \n    plannedRate: data[5].value,\n    duration: data[6].value,\n    changeover: data[7].value\n  }\n\n  if (isValueValid(inputValues)) {\n    const url = utils.influxHost + 'write?db=smart_factory'\n    if (hasTagsChanged(inputValues)) {\n      updateWithTagsChanged(url, inputValues)\n    }else {\n      updateWithTagsUnchanged(url, inputValues)\n    }\n  }\n\n}\n\n/**\n * Send Post request to write the influxdb with the url passed in and the line later created\n * Create a new record with the validated input\n * Update the old record as 'Replaced'\n * Stop and prompt error when it fails\n * @param {*} url \n * @param {*} input \n */\nfunction updateWithTagsChanged(url, input){\n\n  const newLine = writeInfluxLine(input)\n  const oldLine = writeOldInfluxLine()\n  utils.post(url, newLine).then(() => {\n    utils.post(url, oldLine).then(() => {\n      utils.alert('success', 'Success', 'Order has been successfully updated')\n      $('#order-mgt-scheduler-form-cancelBtn').trigger('click')\n    }).catch(error => {\n      console.log(error)\n      utils.alert('error', 'Database Error', 'An error occurred while updating data to the influxdb, please check the basebase connection')\n      $('#order-mgt-scheduler-form-cancelBtn').trigger('click')\n    })\n  }).catch(error => {\n      console.log(error)\n      utils.alert('error', 'Database Error', 'An error occurred while updating data to the influxdb, please check the basebase connection')\n      $('#order-mgt-scheduler-form-cancelBtn').trigger('click')\n  })\n\n}\n\n/**\n * Send Post request to write the influxdb with the url passed in and the line later created\n * Simply update the record\n * Stop and prompt error when it fails\n * @param {*} url \n * @param {*} input \n */\nfunction updateWithTagsUnchanged(url, input){\n\n  const line = writeInfluxLine(input)\n  utils.post(url, line).then(res => {\n    utils.alert('success', 'Success', (rowData !== '' && rowData !== undefined) ? 'Order has been successfully updated' : 'Order has been successfully created')\n    $('#order-mgt-scheduler-form-cancelBtn').trigger('click')\n  }).catch(e => {\n    console.log(e)\n    utils.alert('error', 'Database Error', 'An error occurred while updating data to the influxdb, please check the basebase connection')\n    $('#order-mgt-scheduler-form-cancelBtn').trigger('click')\n  })\n\n}\n\n/**\n * Expect the user inputs\n * Compare the user inputs and the globe scope var called 'rowData'\n * Check if the user inputs is different from the rowData to determine if the Tags are changed\n * @param {*} inputs \n */\nfunction hasTagsChanged(inputs) {\n  \n  if (!rowData) {\n    //if there is no rowData, meaning that the user is creating a new order, so return false\n    return false\n  }\n  const product_id = inputs.product.split(' | ')[0]\n  const product_desc = inputs.product.split(' | ')[1]\n  return (\n    inputs.orderId !== rowData.order_id \n    || product_id !== rowData.product_id \n    || product_desc !== rowData.product_desc\n  )\n}\n\n/**\n * Expect the user inputs\n * Check if the user inputs are valid\n * Stop and prompt error if the inputs are not valid\n * @param {*} data \n */\nfunction isValueValid(data) {\n\n  const dateRegExp = new RegExp('^[0-9]{4}-(((0[13578]|(10|12))-(0[1-9]|[1-2][0-9]|3[0-1]))|(02-(0[1-9]|[1-2][0-9]))|((0[469]|11)-(0[1-9]|[1-2][0-9]|30)))$')\n  const prodList = products.reduce((arr, p) => {\n    const str = p.product_id + ' | ' + p.product_desc\n    arr.push(str)\n    return arr\n  }, [])\n\n  let productionLineList = equipment.reduce((arr, equ) => {\n    arr.push(equ.site + ' | ' + equ.area + ' | ' + equ.production_line)\n    return arr\n  }, [])  \n  productionLineList = utils.distinctElems(productionLineList)\n\n  if (data.orderId === '') {\n    utils.alert('warning', 'Warning', 'Order Number Empty, please enter the Order Number')\n    return false\n  }\n\n  if (data.orderQty === '') {\n    utils.alert('warning', 'Warning', 'Order Quantity Empty, please enter the Order Quantity')\n    return false\n  }\n\n  if (data.productionLine === '') {\n    utils.alert('warning', 'Warning', 'Production Line Empty, please enter the Production Line')\n    return false\n  }else {\n    if (productionLineList.indexOf(data.productionLine) === -1) {\n      utils.alert('warning', 'Warning', 'Production Line Not Exist, please select a Production Line from the Production Line List')\n      return false\n    }\n  }\n\n  if (data.product === '') {\n    utils.alert('warning', 'Warning', 'Product Empty, please enter the Product')\n    return false\n  }else {\n    if (prodList.indexOf(data.product) === -1) {\n      utils.alert('warning', 'Warning', 'Product Not Exist, please select a Product from the Product List')\n      return false\n    }\n  }\n\n  if (!dateRegExp.test(data.date)) {\n    utils.alert('warning', 'Warning', 'Scheduled Start Date Empty or Invalid Date Format, please choose a date from the date picker')\n    return false\n  }\n\n  if (data.plannedRate === '') {\n    utils.alert('warning', 'Warning', 'Planned Rate Empty, please enter the Planned Rate')\n    return false\n  }\n\n  return true\n}\n\n/**\n * Expect the validated user inputs\n * Write line to update the record with the user inputs passed in\n * @param {*} data \n */\nfunction writeInfluxLine (data) {\n  const product_id = data.product.split(' | ')[0]\n  let product_desc = data.product.split(' | ')[1]\n  \n  //For influxdb tag keys, must add a forward slash \\ before each space \n  product_desc = product_desc.split(' ').join('\\\\ ')\n\n  let line = 'OrderPerformance,order_id=' + data.orderId + ',product_id=' + product_id + ',product_desc=' + product_desc + ' '\n\n  //+ ',production_line=' + data.productionLine\n\n  if (rowData) {\n    if (rowData.completion_qty !== null && rowData.completion_qty !== undefined) {\n      line += 'compl_qty=' + rowData.completion_qty + ','\n    }\n    if (rowData.machine_state !== null && rowData.machine_state !== undefined) {\n      line += 'machine_state=\"' + rowData.machine_state + '\"' + ','\n    }\n    if (rowData.scrap_qty !== null && rowData.scrap_qty !== undefined) {\n      line += 'scrap_qty=' + rowData.scrap_qty + ','\n    }\n  }\n\n  line += 'order_state=\"' + 'Planned' + '\"' + ','\n  line += 'order_date=\"' + data.date + '\"' + ','\n  line += 'production_line=\"' + data.productionLine + '\"' + ','\n  line += 'planned_changeover_time=\"' + data.changeover + '\"' + ','\n  line += 'order_qty=' + data.orderQty + ','\n  line += 'setpoint_rate=' + 0 + ','\n  line += 'planned_rate=' + data.plannedRate\n\n  // console.log(line);\n  return line\n}\n\n/**\n * Write line to changed the record's status to 'Replaced'\n */\nfunction writeOldInfluxLine(){\n    //For influxdb tag keys, must add a forward slash \\ before each space \n    let product_desc = rowData.product_desc.split(' ').join('\\\\ ')\n  \n    let line = 'OrderPerformance,order_id=' + rowData.order_id + ',product_id=' + rowData.product_id + ',product_desc=' + product_desc + ' '\n  \n    if (rowData.completion_qty !== null && rowData.completion_qty !== undefined) {\n      line += 'completion_qty=' + rowData.completion_qty + ','\n    }\n    if (rowData.machine_state !== null && rowData.machine_state !== undefined) {\n      line += 'machine_state=\"' + rowData.machine_state + '\"' + ','\n    }\n    if (rowData.scrap_qty !== null && rowData.scrap_qty !== undefined) {\n      line += 'scrap_qty=' + rowData.scrap_qty + ','\n    }\n    if (rowData.setpoint_rate !== null && rowData.setpoint_rate !== undefined) {\n      line += 'setpoint_rate=' + rowData.setpoint_rate + ','\n    }\n\n  \n    line += 'order_state=\"' + 'Replaced' + '\"' + ','\n    line += 'order_date=\"' + rowData.order_date + '\"' + ','\n    line += 'production_line=\"' + rowData.production_line + '\"' + ','\n    line += 'planned_changeover_time=\"' + rowData.planned_changeover_time + '\"' + ','\n    line += 'order_qty=' + rowData.order_qty + ','\n    line += 'planned_rate=' + rowData.planned_rate\n  \n    // console.log(line);\n    return line\n}\n\nexport { showOrderEditingForm }\n"]}