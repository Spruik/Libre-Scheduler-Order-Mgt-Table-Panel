{"version":3,"sources":["../src/action_options_form_ctrl.js"],"names":["showActionOptionsForm","productionLine","orderId","productDesc","productId","tags","prodLine","prodDesc","prodId","_allData","tableCtrl","allData","_rowData","getRowData","console","log","status","toLowerCase","utils","alert","appEvents","emit","src","modalClass","model","removeListeners","addListeners","filter","order","production_line","order_id","product_id","$","document","on","e","target","id","showOrderEditingForm","closeForm","updateOrder","off","action","line","writeInfluxLine","deleteCurrentAndUpdateAffectOrders","post","influx","writeUrl","then","catch","promises","affectedOrders","scheduled_start_datetime","scheduled_end_datetime","order_date","deletingOrderDurationHour","moment","duration","order_qty","planned_rate","deletingOrderChangeover","planned_changeover_time","deletingOrderTotalDur","add","forEach","writeLineForTimeUpdate","push","Promise","all","refreshDashboard","product_desc","split","join","compl_qty","undefined","machine_state","scrap_qty","setpoint_rate","trigger"],"mappings":"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","file":"action_options_form_ctrl.js","sourcesContent":["import { showOrderEditingForm } from './order_form_ctrl'\nimport { appEvents } from 'app/core/core'\nimport * as utils from './utils'\nimport * as tableCtrl from './table_ctrl'\nimport * as influx from './influxHelper'\nimport moment from 'moment'\n\n\nlet _rowData\nlet _allData\n\nconst closeForm = () => {\n  $('a#order-mgt-scheduler-action-option-close-btn').trigger('click')\n}\n\n/**\n * Expect four params which are the tags values and are for querying the record data\n * Show the action options form once the query is finished\n * Remove listener and then add listener, which is to prevent listeners duplication\n * @param {*} productionLine \n * @param {*} orderId \n * @param {*} productDesc \n * @param {*} productId \n */\nfunction showActionOptionsForm(productionLine, orderId, productDesc, productId){\n  //get data\n  let tags = {prodLine: productionLine, orderId: orderId, prodDesc: productDesc, prodId: productId}\n  _allData = tableCtrl.allData()\n  _rowData = getRowData(_allData, tags)\n\n  console.log(_rowData);\n  console.log(_allData);\n  \n  if(_rowData.status.toLowerCase() !== 'planned' && _rowData.status.toLowerCase() !== 'ready'){\n    utils.alert('warning', 'Warning', 'This order is ' + _rowData.status + ' and is no longer available for editing')\n    return\n  }\n\n  appEvents.emit('show-modal', {\n    src: 'public/plugins/smart-factory-scheduler-order-mgt-table-panel/partials/action_options.html',\n    modalClass: 'confirm-modal',\n    model: {}\n  })\n\n  removeListeners()\n  addListeners()\n}\n\n/**\n * Use the tags to filter out the clicked order data from all data\n * And return it\n * @param {*} allData All orders\n * @param {*} tags The tags of the order that is clicked\n */\nfunction getRowData(allData, tags){\n  return allData.filter(order => order.production_line === tags.prodLine \n    && order.order_id === tags.orderId \n    && order.product_id === tags.prodId)[0]\n}\n\n/**\n * Add listener for the action selection\n * If edit clicked, go to the edit form with the current record data\n * If realease clicked, change record status to 'Ready'\n * If delete clicked, change record status to 'Deleted'\n */\nfunction addListeners() {\n  $(document).on('click', 'input[type=\"radio\"][name=\"order-mgt-scheduler-actions-radio\"]', e => {\n    \n    if (e.target.id === 'edit') {\n      showOrderEditingForm(_rowData, _allData)\n    }else if (e.target.id === 'release') {\n      if (_rowData.status === 'Ready') {\n        utils.alert('warning', 'Warning', 'Order has already been released')\n        closeForm()\n      }else {\n        updateOrder('Ready')\n      }\n    }else if (e.target.id === 'delete') {\n      updateOrder('Deleted')\n    }\n\n  })\n}\n\n/**\n * Remove listener for the action selection\n */\nfunction removeListeners() {\n  $(document).off('click', 'input[type=\"radio\"][name=\"order-mgt-scheduler-actions-radio\"]')\n}\n\n/**\n * Expect the action string (Normally are: 'Ready' or 'Deleted')\n * Use the action var passed in to write the line\n * Then update the record\n * Stop and prompt error if it fails\n * @param {*} action \n */\nfunction updateOrder(action) {\n  const line = writeInfluxLine(action)\n  if (action === 'Deleted') {\n    deleteCurrentAndUpdateAffectOrders(line)\n  }else{\n    utils.post(influx.writeUrl, line).then(res => {\n      utils.alert('success', 'Success', 'Order has been marked as ' + action)\n      closeForm()\n    }).catch(e => {\n      utils.alert('error', 'Database Error', 'An error occurred while writing data to the influxdb, please check the basebase connection')\n      closeForm()\n      console.log(e)\n    })\n  }\n}\n\nfunction deleteCurrentAndUpdateAffectOrders(line){\n  //create promises array and put the 'delete current order request' into it first\n  let promises = [utils.post(influx.writeUrl, line)]\n\n  //get all orders data for further filtering\n  const allData = tableCtrl.allData()\n\n  //filter affected orders using all orders data\n  //affected orders = order.startTime >= thisOrder.endtime && in the same line && with the same date.\n  const affectedOrders = allData.filter(order => order.scheduled_start_datetime >= _rowData.scheduled_end_datetime && order.production_line === _rowData.production_line && order.order_date === _rowData.order_date)\n  \n  //work out thisOrder's total duration, which = its duration + its changeover duration\n  const deletingOrderDurationHour = moment.duration(_rowData.order_qty / _rowData.planned_rate, 'hours') \n  const deletingOrderChangeover = moment.duration(_rowData.planned_changeover_time, 'H:mm:ss')\n  const deletingOrderTotalDur = deletingOrderDurationHour.add(deletingOrderChangeover)\n  \n  //loop affected orders, order's starttime and endtime should both subtract the total duration worked out\n  affectedOrders.forEach(order => {\n    const line = influx.writeLineForTimeUpdate(order, deletingOrderTotalDur, 'subtract')\n    promises.push(utils.post(influx.writeUrl, line))\n  })\n\n  Promise.all(promises).then(() => {\n    utils.alert('success', 'Success', 'Order has been marked as Deleted')\n    closeForm()\n    tableCtrl.refreshDashboard()\n  }).catch(e => {\n    utils.alert('error', 'Database Error', 'An error occurred while deleting the order : ' + e)\n    closeForm()\n  })\n}\n\n/**\n * Expect the status string (Normally are: 'Ready' or 'Deleted')\n * Then changed the status in the line with anything else unchanged\n * @param {*} status \n */\nfunction writeInfluxLine(status){\n  //For influxdb tag keys, must add a forward slash \\ before each space \n  let product_desc = _rowData.product_desc.split(' ').join('\\\\ ')\n\n  let line = 'OrderPerformance,order_id=' + _rowData.order_id + ',product_id=' + _rowData.product_id + ',product_desc=' + product_desc + ' '\n\n  if (_rowData.compl_qty !== null && _rowData.compl_qty !== undefined) {\n    line += 'compl_qty=' + _rowData.compl_qty + ','\n  }\n  if (_rowData.machine_state !== null && _rowData.machine_state !== undefined) {\n    line += 'machine_state=\"' + _rowData.machine_state + '\"' + ','\n  }\n  if (_rowData.scrap_qty !== null && _rowData.scrap_qty !== undefined) {\n    line += 'scrap_qty=' + _rowData.scrap_qty + ','\n  }\n  if (_rowData.setpoint_rate !== null && _rowData.setpoint_rate !== undefined) {\n    line += 'setpoint_rate=' + _rowData.setpoint_rate + ','\n  }\n\n  if (_rowData.scheduled_end_datetime !== null && _rowData.scheduled_end_datetime !== undefined) {\n    line += 'scheduled_end_datetime=' + _rowData.scheduled_end_datetime + ','\n    line += 'scheduled_start_datetime=' + _rowData.scheduled_start_datetime + ','\n  }\n\n  line += 'order_state=\"' + status + '\"' + ','\n  line += 'order_date=\"' + _rowData.order_date + '\"' + ','\n  line += 'planned_changeover_time=\"' + _rowData.planned_changeover_time + '\"' + ','\n  line += 'production_line=\"' + _rowData.production_line + '\"' + ','\n  line += 'order_qty=' + _rowData.order_qty + ','\n  line += 'planned_rate=' + _rowData.planned_rate\n\n//   console.log(line);\n  return line\n}\n\nexport { showActionOptionsForm }"]}